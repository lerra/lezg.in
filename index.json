[{"categories":["Documentation"],"content":"The result of this privacy first smart home article will explain how to get the feature to see what is in your fridge while you are doing your grocery shopping with open source solution. Most important, with a high Wife Acceptance Factor.","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/"},{"categories":["Documentation"],"content":"This privacy first smart home article will explain how to get the open source feature to see what is in your fridge while you are doing your grocery shopping. Most important, with a high Wife Acceptance Factor. ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:0:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#"},{"categories":["Documentation"],"content":"Timelapse of the resultHere is a timelapse over two months on my fridge from the solution. Fridge timelaps ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:0:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#timelapse-id"},{"categories":["Documentation"],"content":"Pre-requirements","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:1:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#pre-requierments-id"},{"categories":["Documentation"],"content":"HardwareI used an M5Cam (an ESP32Cam hardware) as I already had one. To my surprise when I was using it for another project I bumped into heating issues and found out that it is a known issue when running it 24/7. So for me, it is a perfect use case as I get cooling out of the box ;-) If you have a powerful cpu (and not a Raspberry Pi) you would not need a Google Coral USB hardware to offload the image processing (TPU). If you have the need of to be 100% sure you get a snapshot every time you open the fridge, then I recommend to use the Google Coral USB hardware or a GPU to offload the image processing. ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:1:1","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#hardware-id"},{"categories":["Documentation"],"content":"SoftwareYou need to setup DOODS, ESPHome, Home Assistant and some remote/VPN capabilities to Home Assistant. My setup is built with privacy in mind, therefore I use solutions I have full control of so I use my own VPN. I would not recommend exposing your Home Assistant directly to the Internet, if you are not good at ensuring you always have the latest version due to security patches. If you don’t want to build your own VPN I would recommend the cloud function of Home Assistant: Nabucasa. It is supposedly built with privacy in mind and is the supporting company behind Home Assistant. ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:1:2","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#software-id"},{"categories":["Documentation"],"content":"The storyDuring the pandemic I had a lot more time, for obvious reasons. So I decided to build something with my M5Cam. Basically an ESP32 hardware with a camera. I managed to get ESPHome to work with it and easily get it connected to Home Assistant. I had an idea to monitor who does the dishes (and cooking) the most, but identifying who’s hand it is above the dishes was a lot harder than I thought (please help me if you know how!) and I did run into heating issues when I was running it for 24/7. So I shifted focus to see if I could put it somewhere that would automatically cool it without me needing to add fans and such, so the fridge was the natural place to test. I started to wire it and mounted the camera to the fridge door with the angle to capture the fridge when the door is open. It was fun to see the stream when I was opening and closing the fridge but I didn’t really want to see a dark picture when I was grocery shopping. So step two was to ensure I always had a image of the latest opening of the fridge. I started to test with some switches and motion detection functionality to capture the picture when it is open but I did not get it to work that good as it was almost always blurry, the door was also not in the “perfect state” to capture the view of the fridge and I would block the view when I was taking grocery in or out. To solve that, I found that there is a tensorflow model that supports the object fridge so I configured DOODS and tested to post an example image from the fridge when the door is open through curl and one of the objects detected was “fridge”, I started to setup the integration between home assistant and DOODS. The last step was to show the latest captured image in Home Assistant. The DOODS integration have some options for the file_out, setting dynamic parameters to the filename. So I have one with the time/date in the filename and a second one that is named latest. With that I can use Home Assistant to emulate a camera by reading the local file and then show it in the interface that would also nicely show up in the app (you can see the screenshot in the feature image on top of this page). ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:2:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#the-story-id"},{"categories":["Documentation"],"content":"The solutionI use the latest esphome docker image to be able to use the latest features of installing via “python pip”, just make sure you have ESPHome version 2021.9. Get the example esphome yaml file from my guthub for the esp32 cam, modify it with your needs. docker pull esphome/esphome docker run --rm -v \"${PWD}\":/config -it esphome/esphome run espcam-fridge-1.yaml Follow the official home assistant documentation to add a ESPHome device to Home Assistant and download DOODS and follow the instructions to get it up and running. After that you can configure Home Assistant to use DOODS for processing the images from the ESP32 camera and store images when the object “fridge” is detected. Here is the relevant section from my Home Assistant configuration.yaml: image_processing: - platform: doods scan_interval: 100 url: \"http://\u003cip-to-doods\u003e:\u003cport-to-doods\u003e\" #detector: edgetpu detector: default file_out: - \"/tmp/{{ camera_entity.split('.')[1] }}\\\\ _latest.jpg\" - \"/camera-storage/fridge/\\\\ {{ camera_entity.split('.')[1] }}_\\\\ {{ now().strftime('%Y%m%d_%H%M%S') }}.jpg\" source: - entity_id: camera.kitchen_m5cam_fridge confidence: 40 labels: - refrigerator To be able to always see the latest image captured in the Home Assistant (through the app or web) you will need to emulate a camera from the local file camera: - platform: local_file name: doods_kitchen_m5cam_fridge file_path: /tmp/kitchen_m5cam\\\\ _fridge_latest.jpg Don’t forget to add the path to Home Assistant configuration.yaml so you don’t get block from use it homeassistant: allowlist_external_dirs: - /tmp - /camera-storage If everything works you can now add the camera in the Home Assistant frontend lovelace with the picture entity card. ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:3:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#the-solution-id"},{"categories":["Documentation"],"content":"The directors cutHere are the images I removed from the top gif. It is not perfect as it will pull an image when it detects a fridge regardless of what is in the picture besides the fridge ;-) Fridge fail timelaps ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:0:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#timelapse-directors-cut-id"},{"categories":["Documentation"],"content":"CreditsCredits goes to the Home Assistant-, DOODS-, ESPHome- team and airijia.com for the ESP32Cam ESPHome example. The platform, and frameworks they have built is fantastic and I hope I could drive more users to focus more on a privacy first setup. A special high five to OttoWinter for the pull request to ESPHome that added lightweight transport encryption to the API, now I am waiting for the same for MQTT ;-) Btw, feel free to send a pull request to the article or reach out on twitter if you find any errors. ","date":"2021-12-19","objectID":"/fridge-cam-with-home-assistant-and-machine-learning/:0:0","series":null,"tags":null,"title":"Privacy first fridge camera empowered with machine learning so I know what to get during grocery shopping","uri":"/fridge-cam-with-home-assistant-and-machine-learning/#timelapse-id"},{"categories":["Documentation"],"content":"This post will guide you through on how to connect a dumb Philips grind \u0026 brew hd7762 coffee machine to your privacy first home automation solution based on home assistant and esphome. Most important, with a high Wife Acceptance Factor.","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/"},{"categories":["Documentation"],"content":"This post will guide you through on how to connect a dumb Philips grind \u0026 brew hd7762 coffee machine to your privacy first home automation solution based on home assistant and esphome. Most important, with a high Wife Acceptance Factor. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:0:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#"},{"categories":["Documentation"],"content":"Pre-requiermentsMy past experience with microcontrollers have been forced by my friend Peter to write LUA code for a rgb controller. Regarding electronics, that was my hobby before my first computer 1996 but on a basic level back then. But I am sure if there is a intresst and some time, this is doable for most of the people. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:1:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#pre-requierments"},{"categories":["Documentation"],"content":"Hardware Philips Grind \u0026 Brew HD7762 ESP32 devkit c v4 I used ESP32 devkit c v4 30-pin but almost any ESP32 will do if you use the right pin’s. Non-contact liquid sensor from CQRobot, other sensors can also be used to be put inside of the tank. Not needed if you don’t care if the coffee machine will grind \u0026 brew with out water in the tank. cables \u0026 usb power adapter. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:1:1","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#hardware-id"},{"categories":["Documentation"],"content":"Repositorygithub ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:2:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#repository-id"},{"categories":["Documentation"],"content":"The storyA couple of years ago, I started with a wake-up routine with my privacy first home automation. Waking up to an emulated sunrise with red, transforming to yellow and then to normal light over a period of fifteen minutes and then, the TV kicking on the circle of life from the Lion king movie. I could start up every morning with a smile and less grumpy. So, I started to think, what’s missing to make my mornings even more awesome. The idea with having fresh coffee would be a great. The only problem I had then was the time, then came the pandemic, as jay-z would say, I got 99 problems, but a time ain’t one. I already had some wires, ESP’s and relays already but I was unsure how the inside of the coffee machine was wired. I was speaking to my friend Peter over the phone that is so deep into the electronics that it is insane, and I told him about what I was planning to do. He said that I might not need a relay to do this and could use the ESP to do this depending on the voltage. He found the service manual online and was checking it but could not find any details about the circuit board. We started to disassemble the coffee machine without me really thinking it through. One hour later, I measured with the multimeter to see where to hook into the circuit and we identified that the voltage is 4.3v and Peter told me that the ESP only supports 3.6V. We decided to test it out anyway and the sacrifice an ESP if it would get killed during the test as other have successfully been running even with 5V. The benefit of a successful test would be one less component (the relay). The circuit board was a lot denser than I thought, and I have not soldered in 20 years, so we agreed that we would meet up to get some help and learn how to do it myself. It took a month before we did that due to the pandemic. Now, working from home and no coffee for a month was challenging. Meanwhile, I ordered the Non-contact liquid sensor from CQRobot to be able to detect water through the plastic container (it also works through glass). With the sensor in place, I could make sure to not turn on the grinding process if the machine was not prepared. Acter a couple of weeks, I got sensor and started to play around with it and identifying exactly where to put the sensor. It’s a really cool one and works by using the sensing capacitance of water and gives back a binary value as a result. So, after a month when we met and started to solder the cables to ground, the “turn on” button and the “start grinding” button. We did a test with the on button and ground connected to see if we needed a relay or not, eventually a new ESP if it would get burned during the test. It turned out that the ESP could manage it and you can see it turning on the coffee machine (the red light on the circuit). Testing the code on the ESP32 to see if we need a relay or not To test the ESP32 if it can handle the 4.3V without burn, the following code was deployed on the ESP through arduino studio before we started to solder. void setup() { pinMode(15, OUTPUT); } void loop() { digitalWrite(15,HIGH); delay(5000); digitalWrite(15, LOW); delay(500); } The curcit board of the Philips Grind \u0026 Brew HD7762 with the cables soldered to grind and on microswitchesThe right solder joint is the on microswitch and the left one is the grind microswitch and ground was connected here So, I started to evolve the code and halfway there I bumped over an article in my rss reader about a home assistant project built upon esphome. I realized I was looking into that project a while ago but forgot the existence. Even if I have invested some time into the code, I realized that I would never come close to the features esphome. It is tightly integrated with home assistant, the possibility to update the code with the OTA (Over The Air, no need for a usb cable to debug or deploy) and a real time event source api for state \u0026 log updates and a rest api, both over json. So, I ported the code to the esphome yaml format and finis","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:3:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#the-story"},{"categories":["Documentation"],"content":"DeploymentStart with the PIN’s you have on your ESP32 to adjust that (search for “pin:\") in the esphome file I built for the coffee machine together with the cqrobot sensor. Use a USB cable for the first deployment to the ESP32, the rest of them can be done over wifi. If you use home assistant, follow the simple steps to add esphome integration. When that is done, the entities will automatically popup in home assistant. If you plan to only use the esphome exposed API’s, you can find the docs here. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:4:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#deployment"},{"categories":["Documentation"],"content":"Making the coffee machine smartSo, what do I mean by “smart”? From how I see it when I can connect the coffee machine to a something bigger. So, the key is to combine it with other sensors and triggers through the privacy first home automation, home assistant. I have been using it for almost four years and it is powerful and open. You can dig deeper into how to get started and the crazy amount of integrations. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#making-it-smart-id"},{"categories":["Documentation"],"content":"The morning routine (or ritual) During a 15 minute period, the wakeup routine starts with a emulated sunrise For two years ago, I started with a wake-up routine. Waking up to an emulated sunrise with red, transforming to yellow and then to normal light over a period of fifteen minutes. After a while, the TV turns on and starts the morning music with Circle of life from the Lion king movie in the front. With this, I started my mornings with a smile and less grumpy. Since I got the coffee machine a part of the home automation setup, I now start grind \u0026 brewing when a motion sensor is triggered outside of the bedroom. This is also switching the wakeup music to the morning news channel. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:1","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#the-morning-routine-id"},{"categories":["Documentation"],"content":"Work from home coffee breaksThis is a fun feature I tested but do not really use but worth sharing. By using the home assistant precense feature we can have used a state if a device or a person is home or on. This could be an app on your phone reporting GPS coordinates, your work laptop connected to your network. As I am using the ESP32 that controls the coffee machine, I can also use esphome report signal measurement for specific bluetooth device (smartwatch, phone etc.) and decide how close it is to the coffee machine. During a test I started the coffee machine during a timeslot and when presence of multiple devices but it’s not that useful as the WFH setup during the pandemic is in the kitchen close by the coffee machine. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:2","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#wfh-breaks-id"},{"categories":["Documentation"],"content":"Start by voice During a 15 minute period, the wakeup routine starts with a emulated sunrise You can use the [home assistant conversation](https://www.home-assistant.io/integrations/conversation/) from the computer or the app to start the coffee brewing by privacy first voice that by saying \"turn on coffee maker\". Honestly, the voice functionality in home assistant is limited, it's more a show then useful as you need to enter the conversation mode and then press the microphone. But if you do not mind to having a voice assistant such as Alexa or google home in your home you can get use that to kick off the coffee and then it allots more useful. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:3","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#start-by-voice-id"},{"categories":["Documentation"],"content":"Start by dropping the magic cube Starting the grinding and brewing of the coffee by dropping the aquara magic cube I have several Aquara Magic Cube and I use the drop motion to kick off the coffee machine. It’s a perfect motion when you are lazy and watching TV or in bed during the weekend when there is no wakeup routine. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:4","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#start-by-a-drop-id"},{"categories":["Documentation"],"content":"Start through the appThis is the most used way we get our fresh coffee and it’s nice to kick off by the end of a power walk to have it ready and fresh when we enter our home. And honestly, sometimes when automation is introduced you quickly identify the corner cases when its get triggered. And Zhuowei Zhang is spot on on his tweet, Never spend 6 minutes doing something by hand when you can spend 6 hours failing to automate it — Zhuowei Zhang (@zhuowei) April 26, 2020 ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:5:5","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#start-through-the-app-id"},{"categories":["Documentation"],"content":"SecurityEsphome does not (yet) support ssl/tls if you dont run a ESP8266 but it is a poor and unsecure implementation. I recommend having separate network segments for both the server \u0026 ESP32, firewall the communication and use separate wpa2 ssid for the device until there is a TLS feature. Since I wrote the article, a lightweight transport encryption for the api have been added to Home Assistant 2021.10 and esphome 2021.9 A special high five to OttoWinter for the feature, now I am waiting for the same for mqtt ;-). ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:0:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#security"},{"categories":["Documentation"],"content":"SafetyDon’t forget to turn on the “keep-warm” functionality on the coffee machine, this will make the appliance to automatically turn it self off after a set time. I highly recommend it to get a safety functionality outside of the code to take care of such if something would fail. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:0:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#safety"},{"categories":["Documentation"],"content":"CredsCreds goes to the home assistant \u0026 esphome team, platform, and frameworks they have built is fantastic and I hope I could drive more users to a privacy first setup and Peter for pushing me during several years to get into the microcontrollers and electronics. PS. No ESP32 got killed or injured during the test, mine have been running fine with 4.3V for two months at the time of drafting this article. Btw, feel free to send a pull request to the article or reach out on twitter if you find any errors. ","date":"2021-02-19","objectID":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/:0:0","series":null,"tags":null,"title":"Adding an API to my grind and brew coffee machine to make it smart","uri":"/adding-an-api-to-my-grind-and-brew-coffee-machine-to-make-it-smart/#creds"}]